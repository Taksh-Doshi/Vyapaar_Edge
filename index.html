<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vyapar Edge — Welcome</title>

  <style>
    :root {
      --saffron: #ff8c4a;
      --blue: #1e40af;
      --muted: #6b7280;
      --bg-soft: #fff8f5;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: white;
      color: #1f2937;
      text-align: center;
      min-height: 100vh;
      overflow-x: hidden; /* Prevent horizontal scroll from particles */
    }

    #loading-screen {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      background: white; z-index: 9999; font-weight: 700; color: var(--blue);
    }

    .landing-wrapper { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
    
    /* HERO SECTION */
    .hero-section {
      min-height: 100vh; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center;
      padding: 4rem 0;
      position: relative; 
    }

    /* PARTICLES CONTAINER */
    #particles-js {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      background-color: transparent;
      z-index: 0; /* Base layer */
    }

    /* Canvas specific fix to ensure it covers area */
    #particles-js canvas {
      display: block;
      vertical-align: bottom;
    }

    .landing-content { 
      max-width: 820px; 
      padding: 2rem; 
      z-index: 10; /* Must be higher than particles */
      position: relative;
      /* Glassmorphism effect so particles are visible behind text but text is readable */
      background: rgba(255, 255, 255, 0.90);
      border: 1px solid rgba(255,255,255,0.5);
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.05);
      backdrop-filter: blur(2px);
    }

    .app-title { font-size: 3rem; color: var(--saffron); margin: 0.2rem 0; font-weight: 900; letter-spacing: -1px; }
    .tagline-one, .tagline-two { margin: 0.25rem 0; font-size: 1.25rem; }
    .tagline-two { color: var(--saffron); font-weight:700; }

    .btn { border: none; cursor: pointer; border-radius: 8px; padding: 0.75rem 1.6rem; font-weight: 700; font-size: 1rem; }
    .btn-cta {
      background: linear-gradient(145deg, var(--saffron), #f96d10);
      color: white; box-shadow: 0 10px 26px rgba(255,128,0,0.35);
      transition: transform 0.2s ease;
    }
    .btn-cta:hover { transform: translateY(-2px); }

    .features-section { background: var(--bg-soft); padding: 3rem 1rem; border-top: 1px solid #f9d8b1; position:relative; z-index: 2; }
    .features-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); max-width:1200px; margin: 0 auto; }
    .feature-card {
      background: white; padding: 1.25rem; border-radius: 12px; text-align: left;
      box-shadow: 0 6px 18px rgba(0,0,0,0.04); border: 1px solid #e5e7eb;
    }
    .feature-card h3 { margin: 0 0 0.5rem 0; font-size: 1.05rem; color: #111827; }
    .feature-card p { margin: 0; color: #4b5563; font-size: 0.95rem; }

    .modal-overlay {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 10000;
      background: rgba(0,0,0,0.45);
    }
    .modal-card {
      width: 92%; max-width: 420px; background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 18px 50px rgba(0,0,0,0.25);
      position: relative;
    }
    .close-btn { position: absolute; right: 12px; top: 10px; border: none; background: none; font-size: 1.2rem; cursor: pointer; color: #9ca3af; }

    .auth-tabs { display:flex; margin-bottom:1rem; }
    .auth-tab { flex:1; padding:0.5rem 0; border:none; background:none; cursor:pointer; font-weight:700; color:var(--muted); }
    .auth-tab.active { color: var(--blue); border-bottom: 2px solid var(--blue); }

    .auth-step { display: none; }
    .auth-step.active { display:block; }

    .form-input { width:100%; padding:0.6rem 0.75rem; margin-bottom:0.8rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.95rem; }
    .form-label { display:block; text-align:left; margin-bottom:0.25rem; font-weight:600; color:#374151; font-size:0.9rem; }

    .link-switch { display:block; margin-top:0.5rem; color:var(--blue); cursor:pointer; text-decoration:none; font-size:0.9rem; }

    #message-box { position: fixed; top: 16px; left: 50%; transform: translateX(-50%); padding: 0.7rem 1rem; border-radius: 8px; display:none; z-index:11000; font-weight:600; }

    a.pdf-link { display:inline-block; margin-top:1rem; color:var(--blue); text-decoration:underline; font-size:0.95rem; }

    @media (max-width:520px) {
      .app-title { font-size: 2.25rem; }
      .tagline-one, .tagline-two { font-size:1rem; }
    }
  </style>
</head>

<body>
  <div id="loading-screen">Initializing Vyapar Edge…</div>
  <div id="message-box" role="alert"></div>

  <div class="landing-wrapper">
    <section id="landing-container" class="hero-section" style="display:none;">
      <div id="particles-js"></div>

      <div class="landing-content">
        <h1 class="app-title">Vyapar Edge</h1>
        <p class="tagline-one">The Power to Control Your Commerce.</p>
        <p class="tagline-two">Digitize stock, eliminate chaos, and maximize profit—all in real-time.</p>

        <div style="margin-top:1.25rem;">
          <button id="get-started-btn" class="btn btn-cta">Get Started</button>
        </div>

      </div>
    </section>

    <section class="features-section">
      <h2 style="text-align:center;margin:0 0 1rem 0;font-size:1.25rem;color:#111827;">Core Features & Operations</h2>
      <p style="text-align:center;color:#6b7280;margin:0 0 1.25rem 0;">Stop tracking manually. Start logging every transaction.</p>

      <div class="features-grid">
        <div class="feature-card">
          <h3>Digital Receipts</h3>
          <p>Instantly log incoming goods and automatically update stock counts upon validation.</p>
        </div>
        <div class="feature-card">
          <h3>Quick Deliveries</h3>
          <p>Track outgoing shipments and reduce inventory automatically when orders are delivered.</p>
        </div>
        <div class="feature-card">
          <h3>Internal Transfers</h3>
          <p>Move stock between racks, floors or warehouses — every move logged in the ledger.</p>
        </div>
        <div class="feature-card">
          <h3>Live Stock & Alerts</h3>
          <p>View real-time stock levels and receive low-stock alerts before you run out.</p>
        </div>
      </div>
    </section>
  </div>

  <div id="auth-modal" class="modal-overlay">
    <div class="modal-card">
      <button id="close-modal-btn" class="close-btn">&times;</button>
      <h3 style="text-align:left;margin:0 0 0.75rem 0;color:#111827;">Log In to Vyapar Edge</h3>
      <div class="auth-tabs">
        <button id="tab-login" class="auth-tab active">Log In</button>
        <button id="tab-signup" class="auth-tab">Sign Up</button>
      </div>
      <div id="form-login" class="auth-step active">
        <form id="login-form">
          <label class="form-label">Email</label>
          <input id="login-email" class="form-input" type="email" required />
          <label class="form-label">Password</label>
          <input id="login-password" class="form-input" type="password" required />
          <button type="submit" class="btn btn-cta" style="width:100%;">Log In</button>
          <a id="forgot-password-link" class="link-switch" href="#">Forgot password?</a>
        </form>
      </div>
      <div id="form-signup" class="auth-step">
        <form id="signup-form">
          <label class="form-label">Email</label>
          <input id="signup-email" class="form-input" type="email" required />
          <label class="form-label">Create password (min 6 chars)</label>
          <input id="signup-password" class="form-input" type="password" required minlength="6" />
          <button type="submit" class="btn btn-cta" style="width:100%;">Create Account</button>
        </form>
      </div>
      <div id="form-reset" class="auth-step">
        <form id="reset-form">
          <label class="form-label">Email for reset</label>
          <input id="reset-email" class="form-input" type="email" required />
          <button type="submit" class="btn btn-cta" style="width:100%;">Send Reset Link</button>
          <a id="back-to-login" class="link-switch" href="#">Back to Login</a>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendPasswordResetEmail,
      signOut,
      setPersistence,
      browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA03Kg26fsyKVf5um3Cp9dp4V1GuwY_YHg",
      authDomain: "vyapparedge.firebaseapp.com",
      projectId: "vyapparedge",
      storageBucket: "vyapparedge.appspot.com",
      messagingSenderId: "419655944278",
      appId: "1:419655944278:web:8288374e722c679974d3f7",
      measurementId: "G-FP9RKL44H7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const USERS_PATH = "users";

    const loadingScreen = document.getElementById("loading-screen");
    const messageBox = document.getElementById("message-box");
    const landingContainer = document.getElementById("landing-container");
    const getStartedBtn = document.getElementById("get-started-btn");

    const authModal = document.getElementById("auth-modal");
    const closeModalBtn = document.getElementById("close-modal-btn");
    const tabLogin = document.getElementById("tab-login");
    const tabSignup = document.getElementById("tab-signup");

    const formLogin = document.getElementById("form-login");
    const formSignup = document.getElementById("form-signup");
    const formReset = document.getElementById("form-reset");

    const loginForm = document.getElementById("login-form");
    const signupForm = document.getElementById("signup-form");
    const resetForm = document.getElementById("reset-form");

    const loginEmail = document.getElementById("login-email");
    const loginPassword = document.getElementById("login-password");
    const signupEmail = document.getElementById("signup-email");
    const signupPassword = document.getElementById("signup-password");
    const resetEmail = document.getElementById("reset-email");

    const forgotPasswordLink = document.getElementById("forgot-password-link");
    const backToLogin = document.getElementById("back-to-login");

    function showMessage(text, isError = false) {
      messageBox.textContent = text;
      messageBox.style.display = "block";
      messageBox.style.background = isError ? "#fee2e2" : "#d1fae5";
      messageBox.style.color = isError ? "#991b1b" : "#065f46";
      clearTimeout(window.__msgTimeout);
      window.__msgTimeout = setTimeout(() => messageBox.style.display = "none", 4500);
    }

    function setAuthMode(mode) {
      tabLogin.classList.remove("active");
      tabSignup.classList.remove("active");
      formLogin.classList.remove("active");
      formSignup.classList.remove("active");
      formReset.classList.remove("active");

      if (mode === "login") { tabLogin.classList.add("active"); formLogin.classList.add("active"); }
      else if (mode === "signup") { tabSignup.classList.add("active"); formSignup.classList.add("active"); }
      else { formReset.classList.add("active"); }
    }

    /* PARTICLE CONFIGURATION */
    function initParticles() {
      if (!window.particlesJS) return;
      
      window.particlesJS("particles-js", {
        "particles": {
          "number": {
            "value": 90,
            "density": { "enable": true, "value_area": 800 }
          },
          "color": { "value": "#ff8c4a" },
          "shape": {
            "type": "circle",
            "stroke": { "width": 0, "color": "#000000" }
          },
          "opacity": {
            "value": 0.6,
            "random": false
          },
          "size": {
            "value": 4,
            "random": true
          },
          "line_linked": {
            "enable": true,
            "distance": 150,
            "color": "#1e40af",
            "opacity": 0.35,
            "width": 1.5
          },
          "move": {
            "enable": true,
            "speed": 2.5,
            "direction": "none",
            "random": false,
            "straight": false,
            "out_mode": "out",
            "bounce": false,
            "attract": { "enable": false, "rotateX": 600, "rotateY": 1200 }
          }
        },
        "interactivity": {
          "detect_on": "canvas",
          "events": {
            "onhover": { "enable": true, "mode": "grab" },
            "onclick": { "enable": true, "mode": "push" },
            "resize": true
          },
          "modes": {
            "grab": { "distance": 180, "line_linked": { "opacity": 1 } },
            "push": { "particles_nb": 4 }
          }
        },
        "retina_detect": true
      });
    }

    async function saveUserProfile(uid, email) {
      try {
        const ref = doc(db, USERS_PATH, uid);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          await setDoc(ref, {
            email,
            name: "New User",
            role: "staff",
            warehouseId: "main_wh",
            isActive: true,
            createdAt: serverTimestamp()
          });
        }
      } catch (e) {
        console.error("saveUserProfile error:", e);
      }
    }

    async function handleSignup(e) {
      e.preventDefault();
      const email = signupEmail.value.trim();
      const password = signupPassword.value;
      if (!email || password.length < 6) {
        showMessage("Please provide valid email & password.", true);
        return;
      }
      try {
        await setPersistence(auth, browserSessionPersistence);
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await saveUserProfile(userCredential.user.uid, email);
        showMessage("Account created — redirecting...");
        authModal.style.display = "none";
      } catch (err) {
        showMessage(err.message, true);
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = loginEmail.value.trim();
      const password = loginPassword.value;
      if (!email || !password) {
        showMessage("Enter email and password.", true);
        return;
      }
      try {
        await setPersistence(auth, browserSessionPersistence);
        await signInWithEmailAndPassword(auth, email, password);
        showMessage("Login successful — redirecting...");
        authModal.style.display = "none";
      } catch (err) {
        showMessage("Invalid email or password.", true);
      }
    }

    async function handleReset(e) {
      e.preventDefault();
      const email = resetEmail.value.trim();
      if (!email) {
        showMessage("Enter your email.", true);
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        showMessage("Password reset link sent.");
        setAuthMode("login");
      } catch (err) {
        showMessage(err.message, true);
      }
    }

    /* -------------- DEV MODE: ALWAYS SIGN OUT -------------- */
    signOut(auth).catch(() => {});

    /* -------------- AUTH STATE LISTENER -------------- */
    onAuthStateChanged(auth, (user) => {
      loadingScreen.style.display = "none";

      if (user) {
        // User logged in
        setTimeout(() => window.location.href = "main_app.html", 700);
      } else {
        // User NOT logged in -> Show landing
        landingContainer.style.display = "flex";
        
        // !!! IMPORTANT: Initialize particles AFTER the container is visible !!!
        // We use a small timeout to ensure DOM layout is recalculated before canvas draws
        setTimeout(() => {
            initParticles();
        }, 100);
      }
    });

    /* -------------- EVENTS -------------- */
    document.addEventListener("DOMContentLoaded", () => {
      getStartedBtn.addEventListener("click", () => {
        authModal.style.display = "flex";
        setAuthMode("login");
      });

      closeModalBtn.addEventListener("click", () => authModal.style.display = "none");
      tabLogin.addEventListener("click", () => setAuthMode("login"));
      tabSignup.addEventListener("click", () => setAuthMode("signup"));

      loginForm.addEventListener("submit", handleLogin);
      signupForm.addEventListener("submit", handleSignup);
      resetForm.addEventListener("submit", handleReset);

      forgotPasswordLink.addEventListener("click", (e) => {
        e.preventDefault();
        setAuthMode("reset");
      });

      backToLogin.addEventListener("click", (e) => {
        e.preventDefault();
        setAuthMode("login");
      });

      authModal.addEventListener("click", (e) => {
        if (e.target === authModal) authModal.style.display = "none";
      });
    });
  </script>
</body>
</html>