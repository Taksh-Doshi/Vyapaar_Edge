<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vyapar Edge - Inventory Management System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind Configuration to adopt Vyapar Edge theme colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vyapar-orange': {
                            50: '#fff8f5',
                            100: '#ffe4d4',
                            600: '#f96d10', // Main CTA orange
                            700: '#ff8c4a', // Lighter accent orange
                        },
                        'vyapar-green': {
                            600: '#059669', // Success/Ledger Green
                        },
                        'vyapar-dark': '#1f2937',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body {
            /* Using the Segoe UI / Roboto font stack from the landing page */
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1280px;
        }
        
        /* Active Tab Styling (Saffron/Orange theme) */
        .tab-button.active {
            @apply bg-vyapar-orange-600 text-white shadow-lg;
        }
        /* Base Card Styling */
        .card {
            @apply bg-white p-6 rounded-xl shadow-xl transition duration-300 hover:shadow-2xl;
        }
        /* Style for the main title color */
        .app-title {
            color: #f96d10; /* Vyapar Edge Orange */
        }
        /* Style for the general action buttons */
        .action-button {
            @apply w-full py-2 px-4 font-semibold rounded-lg transition-colors shadow-md;
        }

        /* Modern Circular Metrics Styling */
        .metric-circle {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem; /* Larger number */
            font-weight: 700;
            color: #f96d10; /* Vyapar Orange */
            background: #fff;
            border: 8px solid #ffe4d4; /* Lighter Vyapar Orange border */
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin: 0 auto; /* Center the circle */
            transition: all 0.3s ease;
            line-height: 1; /* Fix vertical centering */
        }
        .metric-circle.danger {
            border-color: #f87171; /* Red for low stock */
            color: #ef4444;
        }
        .metric-circle:hover {
            border-color: #f96d10; /* Darker border on hover */
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .metric-label {
            margin-top: 0.75rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: #374151; /* Darker text for readability */
            text-align: center;
        }
        /* Dashboard CTA button style */
        .dashboard-cta-button {
            @apply px-8 py-3 bg-vyapar-orange-600 text-white text-lg font-semibold rounded-lg shadow-xl hover:bg-vyapar-orange-700 transition-colors transform hover:scale-105;
        }

        /* Low Stock Alert Bar */
        .low-stock-alert {
            @apply p-4 rounded-lg bg-red-100 border-l-4 border-red-500 text-red-800 font-semibold mb-6 shadow-md cursor-pointer transition-shadow;
        }
        .low-stock-alert:hover {
            @apply shadow-xl;
        }
    </style>
    <!-- Load Firebase Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level (optional, but good for debugging)
        setLogLevel('Debug');

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Core Application State & Global References ---
        let userId = null;
        let products = [];
        let ledger = [];
        let filterText = ''; // State for SKU/Name filtering
        const LOW_STOCK_THRESHOLD = 5; // Define low stock threshold

        // FEATURE: Multi-Warehouse Support - Defines the available locations.
        let locations = [
            { id: 'wh1', name: 'Main Warehouse' },
            { id: 'wh2', name: 'Production Floor' },
            { id: 'rack_a', name: 'Rack A' },
            { id: 'rack_b', name: 'Rack B' }
        ];

        // --- Firestore References ---
        const PRODUCTS_PATH = `/artifacts/${appId}/public/data/products`;
        const LEDGER_PATH = `/artifacts/${appId}/public/data/ledger`;
        const productsCollection = collection(db, PRODUCTS_PATH);
        const ledgerCollection = collection(db, LEDGER_PATH);

        // --- Utility Functions ---

        /** Shows a user message (replaces alert()) */
        function showMessage(type, message) {
            const messageBox = document.getElementById('app-message');
            messageBox.textContent = message;
            // Use Vyapar colors for messages
            const colorClass = type === 'error' ? 'bg-red-500' : 'bg-vyapar-green-600';
            messageBox.className = `p-3 rounded-lg font-semibold mb-4 text-white ${colorClass} transition-all`;
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, 5000);
        }

        /** Formats a number to a currency string */
        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        /** Calculates the total stock for a product across all locations. */
        function getTotalStock(product) {
            if (!product || !product.stock) return 0;
            // product.stock is a map {locationId: quantity}
            return Object.values(product.stock).reduce((sum, qty) => sum + (qty || 0), 0);
        }

        /** Gets stock at a specific location */
        function getStockAtLocation(product, locationId) {
            return (product.stock && product.stock[locationId]) || 0;
        }

        // --- Authentication & Initialization ---

        onAuthStateChanged(auth, async (user) => {
            if (user && !user.isAnonymous) {
                userId = user.uid;
                document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('loading-overlay').classList.add('hidden');
                console.log("Authenticated User:", user.email, "Starting listeners.");
                startListeners();
            } else if (initialAuthToken) {
                 try {
                    await signInWithCustomToken(auth, initialAuthToken);
                 } catch (e) {
                    console.error("Custom token sign-in failed:", e);
                    await signInAnonymously(auth);
                 }
            } else {
                console.log("No authenticated user. Redirecting to login.");
                window.location.href = 'index.html';
            }
        });
        
        window.handleLogout = async function() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed:", error);
                showMessage('error', 'Logout failed. Please try again.');
            }
        }


        // --- Real-time Listeners ---

        function startListeners() {
            // 1. Products Listener (for inventory view and dashboard)
            onSnapshot(productsCollection, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProductsList(); // Renders with current filter state
                renderReceiptsForm();
                renderDeliveriesForm();
                renderTransfersForm();
                renderAdjustmentsForm();
                updateDashboardMetrics(); // Update dashboard with new product data
            }, (error) => {
                console.error("Products listener error:", error);
            });

            // 2. Ledger Listener (for transaction log and dashboard)
            onSnapshot(query(ledgerCollection), (snapshot) => {
                ledger = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => {
                    const tsA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0;
                    const tsB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : 0;
                    return tsB - tsA;
                });
                renderLedger();
                updateDashboardMetrics(); // Update dashboard with new ledger data
            }, (error) => {
                console.error("Ledger listener error:", error);
            });
        }

        // --- Core Stock Transaction Logic (Using Firestore Transaction - Multi-Warehouse enabled) ---

        /**
         * Generic function to process any stock movement that affects a single product.
         * Stock is updated in the product's 'stock' map {locationId: quantity}.
         */
        async function processStockMovement(productId, quantityChange, type, locationId, notes = '') {
            if (!userId) return showMessage('error', 'User not authenticated.');

            const productRef = doc(db, PRODUCTS_PATH, productId);
            const absoluteChange = Math.abs(quantityChange);
            const isDecrease = quantityChange < 0;
            const locationName = locations.find(l => l.id === locationId)?.name || 'Unknown Location';

            try {
                await runTransaction(db, async (transaction) => {
                    const productDoc = await transaction.get(productRef);

                    if (!productDoc.exists()) {
                        throw new Error("Product not found. Cannot process movement.");
                    }

                    const productData = productDoc.data();
                    const currentStockMap = productData.stock || {};
                    const currentStockLocation = currentStockMap[locationId] || 0;
                    
                    const newStockLocation = currentStockLocation + quantityChange;
                    const newStockMap = { ...currentStockMap };

                    // 1. Validate Stock Sufficiency (Crucial for deliveries/transfers)
                    if (isDecrease && currentStockLocation < absoluteChange) {
                        throw new Error(`Insufficient stock: Available ${currentStockLocation} in ${locationName}, Required: ${absoluteChange}.`);
                    }
                    
                    // 2. Update the Stock Map
                    if (newStockLocation <= 0) {
                         delete newStockMap[locationId]; // Clean up if stock hits zero or less
                    } else {
                         newStockMap[locationId] = newStockLocation;
                    }

                    const oldTotalStock = getTotalStock(productData);
                    const newTotalStock = oldTotalStock + quantityChange; 

                    // 3. Update Product Stock Map in Firestore
                    transaction.update(productRef, {
                        stock: newStockMap,
                    });

                    // 4. Log Transaction to Ledger
                    transaction.set(doc(ledgerCollection), {
                        productId: productId,
                        productName: productData.name,
                        locationId: locationId,
                        quantityChange: quantityChange,
                        oldStock: oldTotalStock,
                        newStock: newTotalStock,
                        type: type,
                        notes: notes,
                        timestamp: serverTimestamp(),
                        userId: userId
                    });
                });

                showMessage('success', `${type} validated successfully! Stock updated by ${quantityChange} in ${locationName}.`);
            } catch (e) {
                console.error("Transaction failed:", e);
                showMessage('error', e.message || `Failed to process ${type}.`);
            }
        }

        // --- Dashboard Metrics Calculation & Update ---
        // FEATURE: Alerts for low stock (Implemented here and in UI)

        function updateDashboardMetrics() {
            // Total Products
            document.getElementById('metric-total-products').textContent = products.length;

            // Low or Out of Stock Products
            const lowStockProducts = products.filter(p => getTotalStock(p) <= LOW_STOCK_THRESHOLD);
            const lowStockCount = lowStockProducts.length;
            document.getElementById('metric-low-stock').textContent = lowStockCount;

            // Update Low Stock Alert Bar
            const alertBar = document.getElementById('low-stock-alert-bar');
            alertBar.innerHTML = '';
            if (lowStockCount > 0) {
                alertBar.classList.remove('hidden');
                lowStockProducts.slice(0, 3).forEach(p => {
                    const totalStock = getTotalStock(p);
                    const alertItem = document.createElement('div');
                    alertItem.className = 'low-stock-alert';
                    alertItem.innerHTML = `<span class="font-bold">⚠️ LOW STOCK: ${p.name} (${p.sku})</span> - Total Stock: ${totalStock} units.`;
                    alertBar.appendChild(alertItem);
                });
                if (lowStockProducts.length > 3) {
                     const more = document.createElement('div');
                     more.className = 'text-center text-sm text-red-700 mt-2 font-medium';
                     more.textContent = `...plus ${lowStockProducts.length - 3} more products below threshold.`;
                     alertBar.appendChild(more);
                }
            } else {
                alertBar.classList.add('hidden');
            }

            // Apply danger class to low stock metric
            const lowStockCircle = document.getElementById('circle-low-stock');
            if (lowStockCount > 0) {
                 lowStockCircle.classList.add('danger');
            } else {
                 lowStockCircle.classList.remove('danger');
            }


            // Pending Movements (Last 24h)
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const pendingReceipts = ledger.filter(entry =>
                entry.type === 'Receipt' && entry.timestamp?.toDate && entry.timestamp.toDate() > oneDayAgo
            ).length;
            document.getElementById('metric-pending-receipts').textContent = pendingReceipts;

            const pendingDeliveries = ledger.filter(entry =>
                entry.type === 'Delivery Order' && entry.timestamp?.toDate && entry.timestamp.toDate() > oneDayAgo
            ).length;
            document.getElementById('metric-pending-deliveries').textContent = pendingDeliveries;

            const internalTransfers = ledger.filter(entry =>
                entry.type.startsWith('Transfer') && entry.timestamp?.toDate && entry.timestamp.toDate() > oneDayAgo
            ).length;
            document.getElementById('metric-internal-transfer').textContent = internalTransfers;
        }

        // --- 1. Product Management (Including Search/Filter) ---

        window.handleCreateProduct = async function() {
            const name = document.getElementById('new-product-name').value.trim();
            const sku = document.getElementById('new-product-sku').value.trim();
            const category = document.getElementById('new-product-category').value.trim();
            const uom = document.getElementById('new-product-uom').value.trim();
            // FEATURE: Multi-warehouse - Initial location is required
            const initialLocation = document.getElementById('new-product-location').value; 
            const initialStock = parseInt(document.getElementById('new-product-stock').value) || 0;

            if (!name || !sku || !category || !uom || !initialLocation) {
                return showMessage('error', 'All fields are required.');
            }

            try {
                const newProduct = {
                    name,
                    sku: sku.toUpperCase(),
                    category,
                    uom,
                    stock: {}, // Multi-warehouse: Initialized as an empty map
                    createdAt: serverTimestamp(),
                    userId: userId
                };

                const docRef = await addDoc(productsCollection, newProduct);
                
                // If initial stock is > 0, process it as a receipt to set the initial location stock
                if (initialStock > 0) {
                    await processStockMovement(docRef.id, initialStock, 'Initial Stock', initialLocation, 'Initial stock entry.');
                }

                showMessage('success', `Product "${name}" created successfully.`);

                // Clear form
                document.getElementById('create-product-form').reset();
            } catch (e) {
                console.error("Error creating product:", e);
                showMessage('error', `Failed to create product: ${e.message}`);
            }
        }
        
        // FEATURE: SKU search & smart filters - Event handler for search input
        window.handleFilterChange = function(event) {
            filterText = event.target.value.toLowerCase();
            renderProductsList(); // Re-render the list immediately
        }

        function renderProductsList() {
            const tableBody = document.getElementById('products-list-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            // FEATURE: SKU search & smart filters - Filtering logic applied here
            const filteredProducts = products.filter(p => {
                if (!filterText) return true;
                const matchName = p.name.toLowerCase().includes(filterText);
                const matchSku = p.sku.toLowerCase().includes(filterText);
                return matchName || matchSku;
            });

            filteredProducts.forEach(p => {
                const totalStock = getTotalStock(p);
                // FEATURE: Multi-warehouse - Display stock breakdown by location
                const stockBreakdown = p.stock 
                    ? Object.entries(p.stock)
                        .map(([locId, qty]) => {
                            const locName = locations.find(l => l.id === locId)?.name || locId;
                            return `${locName}: ${formatNumber(qty)}`;
                        })
                        .join(' | ')
                    : 'No Stock';
                
                // FEATURE: Alerts for low stock - Highlight low stock on the list
                const stockClass = totalStock <= LOW_STOCK_THRESHOLD && totalStock > 0 ? 'text-red-500 font-bold' : (totalStock === 0 ? 'text-gray-400' : 'text-vyapar-orange-600');

                const row = tableBody.insertRow();
                row.className = 'hover:bg-vyapar-orange-50 transition-colors';
                row.innerHTML = `
                    <td class="p-3 whitespace-nowrap font-medium text-gray-900">${p.name}</td>
                    <td class="p-3 font-mono text-sm">${p.sku}</td>
                    <td class="p-3">${p.category}</td>
                    <td class="p-3 font-bold text-lg ${stockClass}">${formatNumber(totalStock)}</td>
                    <td class="p-3 text-xs text-gray-600">${stockBreakdown}</td>
                `;
            });
            // Update filter count display
            document.getElementById('product-count-display').textContent = `Showing ${filteredProducts.length} of ${products.length} products`;
        }


        // --- Render functions for Location Selects (reused across forms) ---
        // FEATURE: Multi-Warehouse Support - Centralized location selector rendering
        function renderLocationSelect(selectId, allowNone = false) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const selectedId = select.value;
            select.innerHTML = '';
            if (allowNone) {
                 select.innerHTML = '<option value="">-- Select Location --</option>';
            }
           
            locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.id;
                option.textContent = loc.name;
                if (loc.id === selectedId) option.selected = true;
                select.appendChild(option);
            });
        }

        // --- 2. Receipts (Incoming Goods) ---

        function renderReceiptsForm() {
            const productSelect = document.getElementById('receipt-product-id');
            if (!productSelect) return;

            const selectedId = productSelect.value;
            productSelect.innerHTML = '<option value="">-- Select Product --</option>';
            products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} (${p.sku}) | Total Stock: ${getTotalStock(p)}`;
                if (p.id === selectedId) option.selected = true;
                productSelect.appendChild(option);
            });
            // FEATURE: Multi-Warehouse Support - Location selection added to Receipts
            renderLocationSelect('receipt-location-id', false); // Mandatory location for receipt
        }

        window.handleReceiptValidation = function() {
            const productId = document.getElementById('receipt-product-id').value;
            const supplier = document.getElementById('receipt-supplier').value.trim();
            const quantity = parseInt(document.getElementById('receipt-quantity').value);
            const locationId = document.getElementById('receipt-location-id').value; // Multi-warehouse

            if (!productId || !supplier || !quantity || quantity <= 0 || !locationId) {
                return showMessage('error', 'Please complete all fields (including Location) with a valid quantity (> 0).');
            }

            // Receipt increases stock (positive quantityChange) in the specific location
            processStockMovement(productId, quantity, 'Receipt', locationId, `Supplier: ${supplier}`);

            // Clear form
            document.getElementById('receipt-form').reset();
        }

        // --- 3. Delivery Orders (Outgoing Goods) ---

        function renderDeliveriesForm() {
            const productSelect = document.getElementById('delivery-product-id');
            if (!productSelect) return;

            const selectedId = productSelect.value;
            productSelect.innerHTML = '<option value="">-- Select Product --</option>';
            products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} (${p.sku}) | Total Stock: ${getTotalStock(p)}`;
                if (p.id === selectedId) option.selected = true;
                productSelect.appendChild(option);
            });
            // FEATURE: Multi-Warehouse Support - Location selection added to Deliveries
            renderLocationSelect('delivery-location-id', false); // Mandatory location for delivery
        }

        window.handleDeliveryValidation = function() {
            const productId = document.getElementById('delivery-product-id').value;
            const customerOrder = document.getElementById('delivery-customer-order').value.trim();
            const quantity = parseInt(document.getElementById('delivery-quantity').value);
            const locationId = document.getElementById('delivery-location-id').value; // Multi-warehouse


            if (!productId || !customerOrder || !quantity || quantity <= 0 || !locationId) {
                return showMessage('error', 'Please complete all fields (including Location) with a valid quantity (> 0).');
            }

            // Delivery decreases stock (negative quantityChange) from the specific location
            processStockMovement(productId, -quantity, 'Delivery Order', locationId, `Customer Order: ${customerOrder}`);

            // Clear form
            document.getElementById('delivery-form').reset();
        }

        // --- 4. Internal Transfers (Updated for Multi-Warehouse) ---

        function renderTransfersForm() {
            // Render product select (same as others)
            const productSelect = document.getElementById('transfer-product-id');
            if (productSelect) {
                const selectedId = productSelect.value;
                productSelect.innerHTML = '<option value="">-- Select Product --</option>';
                products.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.name} (${p.sku}) | Total Stock: ${getTotalStock(p)}`;
                    if (p.id === selectedId) option.selected = true;
                    productSelect.appendChild(option);
                });
            }

            // FEATURE: Multi-Warehouse Support - Source and Destination location selects
            renderLocationSelect('transfer-from-location', false);
            renderLocationSelect('transfer-to-location', false);
        }

        window.handleTransferValidation = async function() {
            const productId = document.getElementById('transfer-product-id').value;
            const fromLocation = document.getElementById('transfer-from-location').value;
            const toLocation = document.getElementById('transfer-to-location').value;
            const quantity = parseInt(document.getElementById('transfer-quantity').value);

            if (!productId || !fromLocation || !toLocation || !quantity || quantity <= 0) {
                return showMessage('error', 'Please complete all fields with a valid quantity (> 0).');
            }
            if (fromLocation === toLocation) {
                return showMessage('error', 'Source and Destination locations must be different.');
            }

            const product = products.find(p => p.id === productId);
            if (!product) return showMessage('error', 'Product not found.');

            const currentStockInSource = getStockAtLocation(product, fromLocation);
            if (currentStockInSource < quantity) {
                return showMessage('error', `Insufficient stock in source: Available ${currentStockInSource}.`);
            }

            // A transfer is executed as two separate stock movements via transactions to ensure consistency.
            try {
                // 1. Transaction: Reduce stock from Source Location
                await processStockMovement(productId, -quantity, 'Transfer-Out', fromLocation, `Transfer to ${locations.find(l => l.id === toLocation)?.name}`);

                // 2. Transaction: Increase stock in Destination Location
                await processStockMovement(productId, quantity, 'Transfer-In', toLocation, `Transfer from ${locations.find(l => l.id === fromLocation)?.name}`);


                showMessage('success', `Internal Transfer of ${quantity} units from ${locations.find(l => l.id === fromLocation)?.name} to ${locations.find(l => l.id === toLocation)?.name} validated.`);

                // Clear form
                document.getElementById('transfer-form').reset();
            } catch (e) {
                console.error("Transfer transaction failed:", e);
                // processStockMovement already shows error message, but handle multi-step failure here if needed.
                showMessage('error', `Transfer failed: ${e.message || "A transaction step failed."}`);
            }
        }

        // --- 5. Stock Adjustments (Updated for Multi-Warehouse) ---

        function renderAdjustmentsForm() {
            const productSelect = document.getElementById('adjustment-product-id');
            if (!productSelect) return;

            const selectedId = productSelect.value;
            productSelect.innerHTML = '<option value="">-- Select Product --</option>';
            products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} (${p.sku}) | Total Stock: ${getTotalStock(p)}`;
                if (p.id === selectedId) option.selected = true;
                productSelect.appendChild(option);
            });
            
            // FEATURE: Multi-Warehouse Support - Location selection for specific adjustments
            renderLocationSelect('adjustment-location-id', false); // Mandatory location for adjustment
        }

        window.handleAdjustmentValidation = function() {
            const productId = document.getElementById('adjustment-product-id').value;
            const locationId = document.getElementById('adjustment-location-id').value; // Multi-warehouse
            const countedQuantity = parseInt(document.getElementById('adjustment-counted-quantity').value);
            const reason = document.getElementById('adjustment-reason').value.trim();

            if (!productId || !locationId || !reason || isNaN(countedQuantity) || countedQuantity < 0) {
                return showMessage('error', 'Please complete all fields and enter a valid non-negative counted quantity.');
            }

            const product = products.find(p => p.id === productId);
            if (!product) return showMessage('error', 'Product not found.');

            // Recorded stock is now per location for adjustment
            const recordedStock = getStockAtLocation(product, locationId);
            const change = countedQuantity - recordedStock;

            if (change === 0) {
                return showMessage('success', 'No adjustment needed. Counted quantity matches recorded stock.');
            }

            // Adjustment changes stock by the difference (counted - recorded) in the specific location
            processStockMovement(productId, change, 'Stock Adjustment', locationId, `Reason: ${reason} | Set stock in ${locations.find(l => l.id === locationId)?.name} to ${countedQuantity}`);

            // Clear form
            document.getElementById('adjustment-form').reset();
        }

        // --- 6. General Ledger (Transaction Log) ---

        function renderLedger() {
            const tableBody = document.getElementById('ledger-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const locationMap = locations.reduce((map, loc) => { map[loc.id] = loc.name; return map; }, {});

            ledger.slice(0, 50).forEach(l => { // Show last 50 transactions
                const change = l.quantityChange;
                const changeClass = change > 0 ? 'text-vyapar-green-600 font-bold' : (change < 0 ? 'text-red-600 font-bold' : 'text-gray-500');
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-50 transition-colors text-sm';

                const timestamp = l.timestamp?.toDate ? l.timestamp.toDate().toLocaleString() : 'Processing...';

                row.innerHTML = `
                    <td class="p-3 whitespace-nowrap">${timestamp}</td>
                    <td class="p-3 whitespace-nowrap">${l.type}</td>
                    <td class="p-3">${l.productName}</td>
                    <td class="p-3">${locationMap[l.locationId] || l.locationId}</td>
                    <td class="p-3 text-right ${changeClass}">${change > 0 ? '+' : ''}${formatNumber(change)}</td>
                    <td class="p-3 text-right">${formatNumber(l.oldStock)}</td>
                    <td class="p-3 text-right">${formatNumber(l.newStock)}</td>
                    <td class="p-3 text-xs text-gray-500">${l.notes}</td>
                    <td class="p-3 text-xs text-gray-400">${l.userId.substring(0, 8)}...</td>
                `;
            });
        }

        // --- View Switching Logic ---

        window.currentView = 'dashboard'; // Set default view to dashboard

        window.switchView = function(viewId) {
            window.currentView = viewId;
            document.querySelectorAll('.app-view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(btn => {
                // Apply inactive styling
                btn.classList.remove('active', 'bg-vyapar-orange-600', 'text-white', 'shadow-lg');
                btn.classList.add('bg-vyapar-orange-100', 'text-vyapar-dark');
            });

            document.getElementById(`btn-${viewId}`).classList.add('active');
        }

        // Initial setup on window load
        window.onload = function() {
            // Initial call to set up the default view
            switchView('dashboard');
        }

        // Expose functions globally for HTML access
        window.formatNumber = formatNumber;
        window.locations = locations; // Expose locations for form rendering
        window.renderLocationSelect = renderLocationSelect; // Expose location rendering
    </script>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-200 flex items-center justify-center z-50">
        <div class="text-xl font-semibold text-vyapar-orange-700">Loading Vyapar Edge...</div>
    </div>

    <div id="app-content" class="container mx-auto p-4 md:p-8 hidden">
        <!-- Header & Authentication Status -->
        <header class="mb-6 bg-white p-6 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-start md:items-center">
            <h1 class="text-3xl font-extrabold app-title mb-4 md:mb-0">Vyapar Edge IMS</h1>
            <div class="text-right text-sm text-gray-600 flex items-center space-x-4">
                <div>
                    <p id="user-id-display" class="font-mono text-xs bg-gray-100 p-1 rounded"></p>
                    <p class="mt-1 font-medium">Status: Real-time</p>
                </div>
                <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-colors shadow-md text-sm">
                    Logout
                </button>
            </div>
        </header>

        <!-- Message Box for Feedback -->
        <div id="app-message" class="hidden" role="alert"></div>

        <!-- Navigation Tabs (Below Header, All in a Line) -->
        <nav class="mb-8 p-1 bg-white rounded-xl shadow-lg">
            <div class="flex flex-wrap space-x-1 md:space-x-2">
                <button id="btn-dashboard" onclick="switchView('dashboard')" class="tab-button bg-vyapar-orange-100 text-vyapar-dark px-3 py-2 rounded-lg font-medium text-xs md:text-sm transition-colors flex-grow">
                    Dashboard
                </button>
                <button id="btn-products" onclick="switchView('products')" class="tab-button bg-vyapar-orange-100 text-vyapar-dark px-3 py-2 rounded-lg font-medium text-xs md:text-sm transition-colors flex-grow">
                    1. Product Mgt
                </button>
                <button id="btn-receipts" onclick="switchView('receipts')" class="tab-button bg-vyapar-orange-100 text-vyapar-dark px-3 py-2 rounded-lg font-medium text-xs md:text-sm transition-colors flex-grow">
                    2. Receipts
                </button>
                <button id="btn-deliveries" onclick="switchView('deliveries')" class="tab-button bg-vyapar-orange-100 text-vyapar-dark px-3 py-2 rounded-lg font-medium text-xs md:text-sm transition-colors flex-grow">
                    3. Deliveries
                </button>
                <button id="btn-transfers" onclick="switchView('transfers')" class="tab-button bg-vyapar-orange-100 text-vyapar-dark px-3 py-2 rounded-lg font-medium text-xs md:text-sm transition-colors flex-grow">
                    4. Transfers
                </button>
                <button id="btn-adjustments" onclick="switchView('adjustments')" class="tab-button bg-vyapar-orange-100 text-vyapar-dark px-3 py-2 rounded-lg font-medium text-xs md:text-sm transition-colors flex-grow">
                    5. Adjustments
                </button>
                <button id="btn-ledger" onclick="switchView('ledger')" class="tab-button bg-vyapar-orange-100 text-vyapar-dark px-3 py-2 rounded-lg font-medium text-xs md:text-sm transition-colors flex-grow">
                    Ledger
                </button>
            </div>
        </nav>

        <!-- === DASHBOARD VIEW (New Modern Layout) === -->
        <div id="dashboard" class="app-view">
            <div class="grid grid-cols-1 gap-8">
                <!-- FEATURE: Alerts for low stock - UI element -->
                <div id="low-stock-alert-bar" class="hidden">
                    <!-- Alerts are rendered here by JS updateDashboardMetrics() -->
                </div>
                
                <!-- Welcome Banner Card -->
                <div class="card bg-white p-8 border-l-4 border-vyapar-orange-600 shadow-lg">
                    <h2 class="text-3xl font-extrabold text-vyapar-dark mb-2">Welcome to Vyapar Edge!</h2>
                    <p class="text-lg text-gray-500 mb-6">Your inventory is in real-time. Review today's key movements below or jump straight into a task.</p>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <button onclick="switchView('receipts')" class="dashboard-cta-button">
                            New Goods Receipt
                        </button>
                        <button onclick="switchView('deliveries')" class="dashboard-cta-button bg-vyapar-green-600 hover:bg-vyapar-green-700">
                            Process Delivery Order
                        </button>
                    </div>
                </div>

                <!-- Key Metrics Grid -->
                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Today's Stock Overview</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
                        
                        <!-- Metric 1: Total Products -->
                        <div>
                            <div class="metric-circle">
                                <span id="metric-total-products">0</span>
                            </div>
                            <div class="metric-label">Total Products</div>
                        </div>

                        <!-- Metric 2: Low Stock Products (Red Alert) -->
                        <div>
                            <div id="circle-low-stock" class="metric-circle">
                                <span id="metric-low-stock">0</span>
                            </div>
                            <div class="metric-label">Low or Out of Stock</div>
                        </div>

                        <!-- Metric 3: Pending Receipts (Last 24h) -->
                        <div>
                            <div class="metric-circle">
                                <span id="metric-pending-receipts">0</span>
                            </div>
                            <div class="metric-label">Incoming Receipts (24h)</div>
                        </div>

                        <!-- Metric 4: Pending Deliveries (Last 24h) -->
                        <div>
                            <div class="metric-circle">
                                <span id="metric-pending-deliveries">0</span>
                            </div>
                            <div class="metric-label">Outgoing Deliveries (24h)</div>
                        </div>

                        <!-- Metric 5: Internal Transfers (Last 24h) -->
                        <div>
                            <div class="metric-circle">
                                <span id="metric-internal-transfer">0</span>
                            </div>
                            <div class="metric-label">Internal Transfers (24h)</div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- 1. Product Management View (Updated with Search/Filters) -->
        <div id="products" class="app-view hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Create Product Form -->
                <div class="lg:col-span-1 card h-min">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Create New Product (Multi-Warehouse Ready)</h2>
                    <form id="create-product-form" onsubmit="event.preventDefault(); handleCreateProduct();">
                        <div class="space-y-4">
                            <div>
                                <label for="new-product-name" class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="new-product-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="new-product-sku" class="block text-sm font-medium text-gray-700">SKU / Code</label>
                                    <input type="text" id="new-product-sku" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                                </div>
                                <div>
                                    <label for="new-product-category" class="block text-sm font-medium text-gray-700">Category</label>
                                    <input type="text" id="new-product-category" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="new-product-uom" class="block text-sm font-medium text-gray-700">Unit of Measure</label>
                                    <input type="text" id="new-product-uom" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                                </div>
                                <div>
                                    <label for="new-product-location" class="block text-sm font-medium text-gray-700">Initial Location (Multi-Warehouse)</label>
                                    <select id="new-product-location" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                                        <!-- Locations are populated by JS using renderLocationSelect -->
                                        <script>document.addEventListener('DOMContentLoaded', () => renderLocationSelect('new-product-location', false));</script>
                                    </select>
                                </div>
                            </div>
                             <div>
                                <label for="new-product-stock" class="block text-sm font-medium text-gray-700">Initial Stock (Optional, at Initial Location)</label>
                                <input type="number" id="new-product-stock" value="0" min="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                            </div>
                            <button type="submit" class="action-button bg-vyapar-orange-600 text-white hover:bg-vyapar-orange-700">
                                Save Product
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Products List & Search -->
                <div class="lg:col-span-2 card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Current Inventory</h2>
                    
                    <!-- FEATURE: SKU search & smart filters - UI element -->
                    <div class="mb-4">
                        <input type="text" id="product-search-input" oninput="handleFilterChange(event)" placeholder="Search by SKU or Product Name..." class="w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-3 border">
                        <p id="product-count-display" class="text-sm text-gray-500 mt-2">Showing 0 of 0 products</p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr class="bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <th class="p-3">Name</th>
                                    <th class="p-3">SKU</th>
                                    <th class="p-3">Category</th>
                                    <th class="p-3">Total Stock</th>
                                    <!-- FEATURE: Multi-Warehouse Support - New column for breakdown -->
                                    <th class="p-3">Stock Breakdown (Location)</th> 
                                </tr>
                            </thead>
                            <tbody id="products-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Products will be rendered here by renderProductsList() -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Receipts View -->
        <div id="receipts" class="app-view hidden">
            <div class="max-w-xl mx-auto card">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">New Goods Receipt</h2>
                <p class="text-gray-500 mb-6">Process incoming stock from vendors. Increases 'Stock On Hand' at the selected location.</p>
                <form id="receipt-form" onsubmit="event.preventDefault(); handleReceiptValidation();">
                    <div class="space-y-4">
                        <div>
                            <label for="receipt-product-id" class="block text-sm font-medium text-gray-700">Product</label>
                            <select id="receipt-product-id" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border"></select>
                        </div>
                        <!-- FEATURE: Multi-Warehouse Support - Location added -->
                        <div> 
                            <label for="receipt-location-id" class="block text-sm font-medium text-gray-700">Destination Location (Warehouse/Rack)</label>
                            <select id="receipt-location-id" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border"></select>
                        </div>
                        <div>
                            <label for="receipt-supplier" class="block text-sm font-medium text-gray-700">Supplier/Vendor Name</label>
                            <input type="text" id="receipt-supplier" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                        </div>
                        <div>
                            <label for="receipt-quantity" class="block text-sm font-medium text-gray-700">Quantity Received</label>
                            <input type="number" id="receipt-quantity" required min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                        </div>
                        <button type="submit" class="action-button bg-vyapar-green-600 text-white hover:bg-vyapar-green-700">
                            Validate Receipt (+ Stock)
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 3. Delivery Orders View -->
        <div id="deliveries" class="app-view hidden">
            <div class="max-w-xl mx-auto card">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">New Delivery Order</h2>
                <p class="text-gray-500 mb-6">Process outgoing stock for customer shipment. Decreases 'Stock On Hand' from the selected location.</p>
                <form id="delivery-form" onsubmit="event.preventDefault(); handleDeliveryValidation();">
                    <div class="space-y-4">
                        <div>
                            <label for="delivery-product-id" class="block text-sm font-medium text-gray-700">Product to Deliver</label>
                            <select id="delivery-product-id" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border"></select>
                        </div>
                        <!-- FEATURE: Multi-Warehouse Support - Location added -->
                        <div>
                            <label for="delivery-location-id" class="block text-sm font-medium text-gray-700">Source Location (Warehouse/Rack)</label>
                            <select id="delivery-location-id" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border"></select>
                        </div>
                        <div>
                            <label for="delivery-customer-order" class="block text-sm font-medium text-gray-700">Customer Order Ref</label>
                            <input type="text" id="delivery-customer-order" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                        </div>
                        <div>
                            <label for="delivery-quantity" class="block text-sm font-medium text-gray-700">Quantity to Ship</label>
                            <input type="number" id="delivery-quantity" required min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                        </div>
                        <button type="submit" class="action-button bg-red-600 text-white hover:bg-red-700">
                            Validate Delivery (- Stock)
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 4. Internal Transfers View -->
        <div id="transfers" class="app-view hidden">
            <div class="max-w-xl mx-auto card">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Internal Stock Transfer</h2>
                <p class="text-gray-500 mb-6">Move stock between internal locations. This updates stock levels in both the source and destination locations.</p>
                <form id="transfer-form" onsubmit="event.preventDefault(); handleTransferValidation();">
                    <div class="space-y-4">
                        <div>
                            <label for="transfer-product-id" class="block text-sm font-medium text-gray-700">Product to Transfer</label>
                            <select id="transfer-product-id" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border"></select>
                        </div>
                        <!-- FEATURE: Multi-Warehouse Support - Source/Destination locations -->
                        <div class="grid grid-cols-2 gap-4"> 
                            <div>
                                <label for="transfer-from-location" class="block text-sm font-medium text-gray-700">From Location</label>
                                <select id="transfer-from-location" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border"></select>
                            </div>
                            <div>
                                <label for="transfer-to-location" class="block text-sm font-medium text-gray-700">To Location</label>
                                <select id="transfer-to-location" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border"></select>
                            </div>
                        </div>
                        <div>
                            <label for="transfer-quantity" class="block text-sm font-medium text-gray-700">Quantity to Transfer</label>
                            <input type="number" id="transfer-quantity" required min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                        </div>
                        <button type="submit" class="action-button bg-yellow-600 text-white hover:bg-yellow-700">
                            Validate Transfer
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 5. Stock Adjustments View -->
        <div id="adjustments" class="app-view hidden">
            <div class="max-w-xl mx-auto card">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Stock Adjustment</h2>
                <p class="text-gray-500 mb-6">Fix mismatches between recorded stock and physical count in a specific location.</p>
                <form id="adjustment-form" onsubmit="event.preventDefault(); handleAdjustmentValidation();">
                    <div class="space-y-4">
                        <div>
                            <label for="adjustment-product-id" class="block text-sm font-medium text-gray-700">Product</label>
                            <select id="adjustment-product-id" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border"></select>
                        </div>
                        <!-- FEATURE: Multi-Warehouse Support - Location to Adjust added -->
                        <div> 
                            <label for="adjustment-location-id" class="block text-sm font-medium text-gray-700">Location to Adjust</label>
                            <select id="adjustment-location-id" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border"></select>
                        </div>
                        <div>
                            <label for="adjustment-counted-quantity" class="block text-sm font-medium text-gray-700">Physical Counted Quantity</label>
                            <input type="number" id="adjustment-counted-quantity" required min="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                        </div>
                        <div>
                            <label for="adjustment-reason" class="block text-sm font-medium text-gray-700">Adjustment Reason (e.g., Cycle Count, Breakage)</label>
                            <input type="text" id="adjustment-reason" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-vyapar-orange-600 focus:ring-vyapar-orange-600 p-2 border">
                        </div>
                        <button type="submit" class="action-button bg-teal-600 text-white hover:bg-teal-700">
                            Apply Adjustment (Update Stock)
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 6. General Ledger View -->
        <div id="ledger" class="app-view hidden">
            <div class="card p-0 overflow-x-auto">
                <h2 class="text-xl font-semibold text-gray-800 p-6 border-b">Inventory Transaction Ledger (Last 50 Movements)</h2>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <th class="p-3">Time</th>
                            <th class="p-3">Doc Type</th>
                            <th class="p-3">Product</th>
                            <th class="p-3">Location</th>
                            <th class="p-3 text-right">Change</th>
                            <th class="p-3 text-right">Old Total</th>
                            <th class="p-3 text-right">New Total</th>
                            <th class="p-3">Notes</th>
                            <th class="p-3">User</th>
                        </tr>
                    </thead>
                    <tbody id="ledger-body" class="bg-white divide-y divide-gray-200">
                        <!-- Ledger entries will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</body>
</html>